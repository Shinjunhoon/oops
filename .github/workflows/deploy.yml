name: Build, Push, and Deploy (Docker Hub Strategy)

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. Docker Hub 로그인 (빌드된 이미지를 푸시하기 위해 필수)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 2. Docker 이미지 빌드 및 푸시 (GitHub Runner에서 수행되므로 빠름)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/oops-app:latest


      # 3. EC2 서버에 SSH 명령으로 배포 시작 (Pull 명령만 실행)
      - name: Deploy to EC2 (Pull and Run)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 10m

          # EC2에서 실행할 스크립트: .env 파일 생성 후 Docker Compose 실행
          script: |
            REPO_DIR="/home/${{ secrets.EC2_USER }}/spring-boot-app"
            
            # 4-1️⃣ 리포지토리 파일 업데이트
            if [ ! -d "$REPO_DIR" ]; then
              echo "Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git "$REPO_DIR"
            else
              echo "Pulling latest changes..."
              cd "$REPO_DIR"
              git pull origin main
            fi
            
            cd "$REPO_DIR"
            
            # 4-2️⃣ 환경 변수를 직접 전달하기 위한 변수 목록 생성
            ENV_VARS="DOCKER_USERNAME='${{ secrets.DOCKER_USERNAME }}' \
                      AWS_ACCESS_KEY='${{ secrets.AWS_ACCESS_KEY }}' \
                      AWS_SECRET_KEY='${{ secrets.AWS_SECRET_KEY }}' \
                      AWS_RDS_USERNAME='${{ secrets.AWS_RDS_USERNAME }}' \
                      AWS_RDS_PASSWORD='${{ secrets.AWS_RDS_PASSWORD }}' \
                      MAIL_PASSWORD='${{ secrets.MAIL_PASSWORD }}' \
                      JWT_SECRET='${{ secrets.JWT_SECRET }}'"
            
            echo "Environment variables prepared."
            
            # 4-3️⃣ 최신 Docker 이미지 Pull (변수를 포함하여 실행)
            echo "Pulling latest image from Docker Hub..."
            sudo $ENV_VARS docker-compose pull app # 'app' 서비스만 pull
            
            # 4-4️⃣ 컨테이너 재시작 (변수를 포함하여 실행)
            echo "Starting containers..."
            sudo $ENV_VARS docker-compose up -d --force-recreate
            
            echo "Deployment complete. Spring Boot and Redis services are running."